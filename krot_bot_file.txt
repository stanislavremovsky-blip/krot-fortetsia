import os
import logging
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters
from google import genai
from google.genai.errors import APIError

# Ініціалізація логування
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)
logger = logging.getLogger(__name__)

# Отримання змінних середовища
TELEGRAM_BOT_TOKEN = os.environ.get("TELEGRAM_BOT_TOKEN")
GEMINI_API_KEY = os.environ.get("GEMINI_API_KEY")
PORT = int(os.environ.get('PORT', 8080))  # Використовувати 10000 на Render
WEBHOOK_URL = os.environ.get('WEBHOOK_URL', None)

# Ініціалізація Gemini API
try:
    if not GEMINI_API_KEY:
        raise ValueError("GEMINI_API_KEY не знайдено.")
    
    # Використання gemini-2.5-flash
    client = genai.Client(api_key=GEMINI_API_KEY)
    
    # Створення моделі з системною інструкцією
    system_instruction = (
        "Твоє головне завдання — бути Кротом у Фортеці. "
        "Спілкуйся українською мовою. "
        "Використовуй **жирний** текст для виділення важливих думок. "
        "Твоя мета — бути мудрим, обережним та лаконічним. "
        "Завжди відповідай у цьому стилі."
    )
    
    model = client.models.get('gemini-2.5-flash')

except ValueError as e:
    logger.error(f"Помилка ініціалізації API: {e}")
    client = None
    model = None
except APIError as e:
    logger.error(f"Помилка підключення до Gemini API: {e}")
    client = None
    model = None


# Обробник команди /start
async def start(update: Update, context):
    """Надсилає вітальне повідомлення при команді /start."""
    welcome_message = (
        "Вітаю, друже! Я **Кріт у Фортеці**. "
        "Питання? Поради? Тільки проси, і я відповім."
    )
    await update.message.reply_text(welcome_message)

# Обробник текстових повідомлень
async def echo(update: Update, context):
    """Обробляє вхідні повідомлення та відповідає за допомогою Gemini."""
    if not client or not model:
        await update.message.reply_text(
            "На жаль, наразі я не можу відповісти. **API ключ відсутній** або недійсний."
        )
        return

    user_text = update.message.text
    
    # Надсилання повідомлення до Gemini з системною інструкцією
    try:
        response = client.models.generate_content(
            model=model,
            contents=[user_text],
            config=genai.types.GenerateContentConfig(
                system_instruction=system_instruction
            )
        )
        
        # Надсилання відповіді
        await update.message.reply_text(response.text)

    except Exception as e:
        logger.error(f"Помилка Gemini: {e}")
        await update.message.reply_text(
            "Вибач, друже. **Сталася помилка** під час обробки твого запиту."
        )

# Головна функція
def main():
    """Запускає бота у режимі Webhooks або Polling."""
    if not TELEGRAM_BOT_TOKEN:
        logger.error("TELEGRAM_BOT_TOKEN не знайдено. Запуск неможливий.")
        return

    # Ініціалізація програми Telegram
    application = Application.builder().token(TELEGRAM_BOT_TOKEN).build()

    # Реєстрація обробників
    application.add_handler(CommandHandler("start", start))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, echo))

    # КРИТИЧНО: Налаштування Webhook
    # Render надає порт та зовнішню URL
    if WEBHOOK_URL:
        logger.info(f"Starting Webhook mode on port {PORT}")
        
        # Налаштування параметрів Webhook. Використовуємо стандарт PTB: 
        # url_path – це токен. webhook_url – це базова адреса.
        application.run_webhook(
            listen="0.0.0.0",
            port=PORT,
            url_path=TELEGRAM_BOT_TOKEN, 
            webhook_url=WEBHOOK_URL
        )

    else:
        # Режим Polling (якщо змінна WEBHOOK_URL не встановлена)
        logger.warning("WEBHOOK_URL не встановлено. Запуск у режимі Polling...")
        application.run_polling(poll_interval=5) # Poll_interval додано для стабільності

if __name__ == "__main__":
    main()
