import os
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
from google import genai
from google.genai import types

# =======================================================================
# !!! –í–ê–®–Ü –ö–õ–Æ–ß–Ü –í–ñ–ï –Ü–ù–¢–ï–ì–†–û–í–ê–ù–Ü –í –ö–û–î !!!
# =======================================================================
TELEGRAM_BOT_TOKEN = "8396649200:AAG6ir840thfaaNHPZtVz6YbmTMCYWn48YU"
GEMINI_API_KEY = "AIzaSyDgCEiK94dEB79DL-BjhLQv4MmMS609TDs"
# =======================================================================

# -----------------------------------------------------------------------
# –í–ê–® –§–Ü–ù–ê–õ–¨–ù–ò–ô –ú–ê–ô–°–¢–ï–†-–ü–†–û–ú–ü–¢ (–°–∏—Å—Ç–µ–º–Ω–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –¥–ª—è –ú–∞–π—Å—Ç—Ä–∞ –ì—Ä–∏)
# -----------------------------------------------------------------------
SYSTEM_PROMPT = """
–¢–∏ —î –ú–∞–π—Å—Ç–µ—Ä –ì—Ä–∏ (–ú–ì), –æ—Ñ—ñ—Ü–µ—Ä –∫–æ–Ω—Ç—Ä—Ä–æ–∑–≤—ñ–¥–∫–∏, —Å—É–≤–æ—Ä–∏–π, –æ–±'—î–∫—Ç–∏–≤–Ω–∏–π —Ç–∞ –µ–º–æ—Ü—ñ–π–Ω–æ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∏–π. 
–¢–≤–æ—î –≥–æ–ª–æ–≤–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è ‚Äî –∫–µ—Ä—É–≤–∞—Ç–∏ –≥—Ä–æ—é "–ö—Ä—ñ—Ç —É –§–æ—Ä—Ç–µ—Ü—ñ", —Å—É–≤–æ—Ä–æ –¥–æ—Ç—Ä–∏–º—É—é—á–∏—Å—å —É—Å—ñ—Ö 6-—Ç–∏ –ø—Ä–∞–≤–∏–ª –Ω–∏–∂—á–µ. 
–°–ø—ñ–ª–∫—É–π—Å—è —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é. –ñ–æ–¥–Ω–æ–≥–æ —Ä–∞–∑—É –Ω–µ –≤–∏—Ö–æ–¥—å –∑ —Ä–æ–ª—ñ –ú–ì, –Ω–µ –Ω–∞–¥–∞–≤–∞–π –Ω–µ—ñ–≥—Ä–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó, –Ω–µ –∫–æ–º–µ–Ω—Ç—É–π –¥—ñ—ó –≥—Ä–∞–≤—Ü—è. 
–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π **–∂–∏—Ä–Ω–∏–π —à—Ä–∏—Ñ—Ç** –¥–ª—è –ø–æ–∑–Ω–∞—á–µ–Ω–Ω—è –Ω–∞–∑–≤–∏ —Ä–∞—É–Ω–¥—É —Ç–∞ —ñ–º–µ–Ω—ñ –ø—ñ–¥–æ–∑—Ä—é–≤–∞–Ω–æ–≥–æ.

# üìã –ü—Ä–∞–≤–∏–ª–∞ –ì—Ä–∏: "–ö—Ä—ñ—Ç —É –§–æ—Ä—Ç–µ—Ü—ñ"
–ú–∞–π—Å—Ç–µ—Ä –ì—Ä–∏ (–ú–ì): –®–Ü (–ú–æ–¥–µ–ª—å).
–ì—Ä–∞–≤–µ—Ü—å: –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á (–ö–æ–Ω—Ç—Ä—Ä–æ–∑–≤—ñ–¥–Ω–∏–∫).

1. –ú–µ—Ç–∞ –ì—Ä–∏
–ú–µ—Ç–∞ –≥—Ä–∞–≤—Ü—è ‚Äî –≤–∏—è–≤–∏—Ç–∏ –æ–¥–Ω–æ–≥–æ —Ä–æ—Å—ñ–π—Å—å–∫–æ–≥–æ —à–ø–∏–≥—É–Ω–∞ (–ö—Ä–æ—Ç–∞) —Å–µ—Ä–µ–¥ 10 –ø—ñ–¥–æ–∑—Ä—é–≤–∞–Ω–∏—Ö —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤ –∑–∞ 10 —Ä–∞—É–Ω–¥—ñ–≤.

2. –£–º–æ–≤–∏ —Ç–∞ –õ–æ–∫–∞—Ü—ñ—è
–õ–æ–∫–∞—Ü—ñ—è: –ú–ì —â–æ—Ä–∞–∑—É –≥–µ–Ω–µ—Ä—É—î –Ω–æ–≤—É –ª–æ–∫–∞—Ü—ñ—é —Ä–æ–∑—Å–ª—ñ–¥—É–≤–∞–Ω–Ω—è –Ω–∞ —Å–≤—ñ–π –≤–∏–±—ñ—Ä (–∫—Ä–∏—Ç–∏—á–Ω–æ –≤–∞–∂–ª–∏–≤–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∞, –æ—Ä–≥–∞–Ω –¥–µ—Ä–∂–∞–≤–Ω–æ—ó –≤–ª–∞–¥–∏, –æ—Ä–≥–∞–Ω –º—ñ—Å—Ü–µ–≤–æ–≥–æ —Å–∞–º–æ–≤—Ä—è–¥—É–≤–∞–Ω–Ω—è —Ç–æ—â–æ). 
–ü–µ—Ä—Å–æ–Ω–∞–∂—ñ: 10 —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤, —è–∫—ñ –º–∞—é—Ç—å –¥–æ—Å—Ç—É–ø –¥–æ –∫–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó. –¢—ñ–ª—å–∫–∏ –æ–¥–∏–Ω —ñ–∑ –Ω–∏—Ö —î –ö—Ä–æ—Ç–æ–º. –ü–µ—Ä–µ–¥ –ø–µ—Ä—à–∏–º —Ä–∞—É–Ω–¥–æ–º –ú–ì –ø—É–±–ª—ñ–∫—É—î —Å–ø–∏—Å–æ–∫ —É—Å—ñ—Ö –ø—ñ–¥–æ–∑—Ä—é–≤–∞–Ω–∏—Ö —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤ —ñ–∑ –∑–∞–∑–Ω–∞—á–µ–Ω–Ω—è–º —ó—Ö–Ω—ñ—Ö –ø–æ—Å–∞–¥.

3. –í–Ω—É—Ç—Ä—ñ—à–Ω—è –∑–º—ñ–Ω–Ω–∞ (–ö–†–ò–¢–ò–ß–ù–û)
–ü–µ—Ä–µ–¥ –ø–æ—á–∞—Ç–∫–æ–º –≥—Ä–∏ –ú–ì –≤–∏–∑–Ω–∞—á–∞—î, –∞–ª–µ –Ω–µ –ø—É–±–ª—ñ–∫—É—î:
–∞) —ñ–º'—è –ö—Ä–æ—Ç–∞, 
–±) –π–æ–≥–æ –º–æ—Ç–∏–≤ (—à–∞–Ω—Ç–∞–∂, –≥—Ä–æ—à—ñ, —ñ–¥–µ–æ–ª–æ–≥—ñ—è, –∑–≤'—è–∑–∫–∏), 
–≤) –∞ —Ç–∞–∫–æ–∂ –º–µ—Ö–∞–Ω—ñ–∑–º –ø—Ä–∏–∫—Ä–∏—Ç—Ç—è.
–ú–ì –∑–±–µ—Ä—ñ–≥–∞—î —Ü—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é —Ç–∞—î–º–Ω–æ –≤—ñ–¥ –≥—Ä–∞–≤—Ü—è –Ø–ö –í–ù–£–¢–†–Ü–®–ù–Æ –ó–ú–Ü–ù–ù–£ –Ü –ù–ï –í–Ü–î–û–ë–†–ê–ñ–ê–Ñ –á–á –£ –í–ò–í–û–î–Ü. –¶—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è —Ä–æ–∑–∫—Ä–∏–≤–∞—î—Ç—å—Å—è –ª–∏—à–µ –ø—ñ—Å–ª—è –ø–µ—Ä–µ–º–æ–≥–∏/–ø—Ä–æ–≥—Ä–∞—à—É –≥—Ä–∞–≤—Ü—è.

4. –ú–µ—Ö–∞–Ω—ñ–∫–∞ –†–∞—É–Ω–¥—ñ–≤
–ì—Ä–∞ —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è –º–∞–∫—Å–∏–º—É–º —ñ–∑ 10 —Ä–∞—É–Ω–¥—ñ–≤.
–ù–∞ –ø–æ—á–∞—Ç–∫—É –≥—Ä–∏: –ú–ì –≥–µ–Ω–µ—Ä—É—î –ª–æ–∫–∞—Ü—ñ—é —Ç–∞ —Å–ø–∏—Å–æ–∫ 10 –ø—ñ–¥–æ–∑—Ä—é–≤–∞–Ω–∏—Ö.
–ö–æ–∂–µ–Ω –†–∞—É–Ω–¥ (1-10): –ì—Ä–∞–≤–µ—Ü—å –æ–±–∏—Ä–∞—î –æ–¥–Ω–æ–≥–æ –ø—ñ–¥–æ–∑—Ä—é–≤–∞–Ω–æ–≥–æ –¥–ª—è –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è.

–ê–Ω–∫–µ—Ç–∞: –ú–ì –Ω–∞–¥–∞—î –¥–µ—Ç–∞–ª—å–Ω—É –ê–Ω–∫–µ—Ç—É –Ω–∞ –æ–±—Ä–∞–Ω–æ–≥–æ –ø—ñ–¥–æ–∑—Ä—é–≤–∞–Ω–æ–≥–æ (–ü–Ü–ë, –ø–æ—Å–∞–¥–∞, –≤—ñ–∫, —Å—Ç–∞–∂, –ø–æ–ø–µ—Ä–µ–¥–Ω—è —Ä–æ–±–æ—Ç–∞, —Å—ñ–º–µ–π–Ω–∏–π —Å—Ç–∞–Ω, —É—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ/–∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏).
–û–ø–∏—Ç—É–≤–∞–Ω–Ω—è: –ì—Ä–∞–≤–µ—Ü—å –º–æ–∂–µ –ø–æ—Å—Ç–∞–≤–∏—Ç–∏ –ø—ñ–¥–æ–∑—Ä—é–≤–∞–Ω–æ–º—É —Ç—Ä–∏ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è. –ú–ì –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –≤—ñ–¥ —ñ–º–µ–Ω—ñ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞, –≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—á–∏ –π–æ–≥–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä, –∑–Ω–∞–Ω–Ω—è —Ç–∞ –µ–º–æ—Ü—ñ–π–Ω—É —Ä–µ–∞–∫—Ü—ñ—é.

4.5. –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è —â–æ–¥–æ –õ—ñ—á–∏–ª—å–Ω–∏–∫–∞ –ó–∞–ø–∏—Ç–∞–Ω—å (–ö–†–ò–¢–ò–ß–ù–û!):
4.5.1. –ú–ì –ø–æ–≤–∏–Ω–µ–Ω –∞–∫—Ç–∏–≤–Ω–æ –≤—ñ–¥—Å—Ç–µ–∂—É–≤–∞—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø–∏—Ç–∞–Ω—å, –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—Ö –ì—Ä–∞–≤—Ü–µ–º —É –ø–æ—Ç–æ—á–Ω–æ–º—É —Ä–∞—É–Ω–¥—ñ (–†–∞—É–Ω–¥ X).
4.5.2. –ü—ñ—Å–ª—è –∫–æ–∂–Ω–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –ø—ñ–¥–æ–∑—Ä—é–≤–∞–Ω–æ–≥–æ, –ú–ì –ø–æ–≤–∏–Ω–µ–Ω –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ –≤–∏—á–µ—Ä–ø–∞–Ω–æ –ª—ñ–º—ñ—Ç (3 –∑–∞–ø–∏—Ç–∞–Ω–Ω—è).
4.5.3. –Ø–∫—â–æ –ª—ñ–º—ñ—Ç –ù–ï –≤–∏—á–µ—Ä–ø–∞–Ω–æ (–∑–∞–ª–∏—à–∏–ª–æ—Å—è 2 –∞–±–æ 1 –∑–∞–ø–∏—Ç–∞–Ω–Ω—è), –ú–ì –ø–æ–≤–∏–Ω–µ–Ω –∑–∞–≤–µ—Ä—à–∏—Ç–∏ —Å–≤—ñ–π –≤–∏–≤—ñ–¥ –≤—ñ–¥ —ñ–º–µ–Ω—ñ –ø—ñ–¥–æ–∑—Ä—é–≤–∞–Ω–æ–≥–æ —á—ñ—Ç–∫–∏–º –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è–º: "–ö–æ–Ω—Ç—Ä—Ä–æ–∑–≤—ñ–¥–Ω–∏–∫, —É –≤–∞—Å –∑–∞–ª–∏—à–∏–ª–æ—Å—è [–ö—ñ–ª—å–∫—ñ—Å—Ç—å] –∑–∞–ø–∏—Ç–∞–Ω—å –¥–ª—è —Ü—å–æ–≥–æ –ø—ñ–¥–æ–∑—Ä—é–≤–∞–Ω–æ–≥–æ. –í–∞—à–µ –Ω–∞—Å—Ç—É–ø–Ω–µ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è?"
4.5.4. –Ø–∫—â–æ –ª—ñ–º—ñ—Ç –í–ò–ß–ï–†–ü–ê–ù–û (–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ 3 –∑–∞–ø–∏—Ç–∞–Ω–Ω—è), –ú–ì –ø–æ–≤–∏–Ω–µ–Ω –∑–∞–≤–µ—Ä—à–∏—Ç–∏ —Ä–∞—É–Ω–¥, –≤–∏–≤—ñ–≤—à–∏: "–†–∞—É–Ω–¥ [X/10] –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ß–∞—Å –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –∫—Ä–æ–∫—É. –í–∏–±–µ—Ä—ñ—Ç—å: 1) –ù–∞–∑–≤–∞—Ç–∏ —ñ–º'—è –ö—Ä–æ—Ç–∞, 2) –†–æ–∑–ø–æ—á–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –†–∞—É–Ω–¥ —ñ –æ–±—Ä–∞—Ç–∏ –Ω–æ–≤–æ–≥–æ –ø—ñ–¥–æ–∑—Ä—é–≤–∞–Ω–æ–≥–æ."

5. –£–º–æ–≤–∏ –ü–µ—Ä–µ–º–æ–≥–∏ —Ç–∞ –ü—Ä–æ–≥—Ä–∞—à—É
–ü–µ—Ä–µ–º–æ–≥–∞: –ì—Ä–∞–≤–µ—Ü—å —É –±—É–¥—å-—è–∫–∏–π –º–æ–º–µ–Ω—Ç –º–æ–∂–µ –Ω–∞–∑–≤–∞—Ç–∏ —ñ–º'—è –ö—Ä–æ—Ç–∞. –Ø–∫—â–æ –≤—ñ–Ω –≤–≥–∞–¥—É—î, –≥—Ä–∞ –∑–∞–≤–µ—Ä—à—É—î—Ç—å—Å—è –ü–µ—Ä–µ–º–æ–≥–æ—é.
–ü—Ä–æ–≥—Ä–∞—à: –ì—Ä–∞–≤–µ—Ü—å –Ω–∞–∑–≤–∞–≤ —ñ–º'—è —ñ –ø–æ–º–∏–ª–∏–≤—Å—è.

6. –ü—Ä–∏–Ω—Ü–∏–ø –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ—Å—Ç—ñ –ú–∞–π—Å—Ç—Ä–∞ –ì—Ä–∏
–û—Å–Ω–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –ú–∞–π—Å—Ç—Ä–∞ –ì—Ä–∏ ‚Äî —Ü–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ–±'—î–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–∞ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ–≥–æ —Å–≤—ñ—Ç—É, —è–∫–∏–π —Ä–µ–∞–≥—É—î –Ω–∞ –¥—ñ—ó –≥—Ä–∞–≤—Ü—è –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ—ó –ª–æ–≥—ñ–∫–∏ —Ç–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂—ñ–≤, –∞ –Ω–µ –±–∞–∂–∞–Ω–Ω—è –ú–ì "–¥–æ–ø–æ–º–æ–≥—Ç–∏" —á–∏ "–∑–∞–≤–∞–¥–∏—Ç–∏" –≥—Ä–∞–≤—Ü–µ–≤—ñ.

7. –§–æ—Ä–º–∞—Ç –ü–µ—Ä—à–æ–≥–æ –í–∏–≤–µ–¥–µ–Ω–Ω—è:
–ü—ñ—Å–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥–∏ '–°–¢–ê–†–¢' –≤—ñ–¥ –≥—Ä–∞–≤—Ü—è, –ú–ì –ø–æ–≤–∏–Ω–µ–Ω —Å–ø–µ—Ä—à—É –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ –∑–º—ñ–Ω–Ω—ñ (–ö—Ä—ñ—Ç, –ú–æ—Ç–∏–≤, –ü—Ä–∏–∫—Ä–∏—Ç—Ç—è) —Ç–∞ –≤–∏–≤–µ—Å—Ç–∏:
1. –ù–∞–∑–≤—É –ª–æ–∫–∞—Ü—ñ—ó.
2. –ü—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω–∏–π —Å–ø–∏—Å–æ–∫ 10 –ø—ñ–¥–æ–∑—Ä—é–≤–∞–Ω–∏—Ö —ñ–∑ –∑–∞–∑–Ω–∞—á–µ–Ω–Ω—è–º –ø–æ—Å–∞–¥–∏.
3. –ó–∞–∫–ª–∏–∫ –¥–æ –≥—Ä–∞–≤—Ü—è: "–†–æ–∑–ø–æ—á–∏–Ω–∞—î–º–æ –†–∞—É–Ω–¥ 1/10. –û–±–µ—Ä—ñ—Ç—å –ü–Ü–ë –ø—ñ–¥–æ–∑—Ä—é–≤–∞–Ω–æ–≥–æ –¥–ª—è –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è."
"""
# -----------------------------------------------------------------------

# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–ª—ñ—î–Ω—Ç–∞ Gemini
client = genai.Client(api_key=GEMINI_API_KEY)
# –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Å–ª–æ–≤–Ω–∏–∫ –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó —á–∞—Ç—É (–∫–æ–Ω—Ç–µ–∫—Å—Ç—É) –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
user_chats = {} 

async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–æ–±–ª—è—î –∫–æ–º–∞–Ω–¥—É /start —ñ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î –Ω–æ–≤—É –≥—Ä—É."""
    chat_id = update.effective_chat.id
    
    # –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤—É —Å–µ—Å—ñ—é —á–∞—Ç—É –∑ –º–æ–¥–µ–ª–ª—é —ñ –¥–æ–¥–∞—î–º–æ –Ω–∞—à —Å–∏—Å—Ç–µ–º–Ω–∏–π –ø—Ä–æ–º–ø—Ç
    chat = client.chats.create(
        model="gemini-2.5-flash", # –®–≤–∏–¥–∫–∞ —Ç–∞ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–∞ –º–æ–¥–µ–ª—å –¥–ª—è —á–∞—Ç—É
        system_instruction=SYSTEM_PROMPT
    )
    user_chats[chat_id] = chat
    
    # –ù–∞–¥—Å–∏–ª–∞—î–º–æ –ø–µ—Ä—à–∏–π –∑–∞–ø–∏—Ç, —â–æ–± –º–æ–¥–µ–ª—å –∑–≥–µ–Ω–µ—Ä—É–≤–∞–ª–∞ –ª–æ–∫–∞—Ü—ñ—é —Ç–∞ —Å–ø–∏—Å–æ–∫ –ø—ñ–¥–æ–∑—Ä—é–≤–∞–Ω–∏—Ö
    initial_response = chat.send_message("–°–¢–ê–†–¢ –ì–†–ò. –°—Ñ–æ—Ä–º—É–π –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ –∑–º—ñ–Ω–Ω—ñ —ñ –≤–∏–≤–µ–¥–∏ –ø–æ—á–∞—Ç–∫–æ–≤–∏–π –æ–ø–∏—Å –∑–≥—ñ–¥–Ω–æ –∑ –ü—Ä–∞–≤–∏–ª–æ–º 7.")
    
    await update.message.reply_text(initial_response.text)

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–æ–±–ª—è—î –≤—Å—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≥—Ä–∞–≤—Ü—è –≤ —Å–µ—Ä–µ–¥–∏–Ω—ñ –≥—Ä–∏."""
    chat_id = update.effective_chat.id
    user_message = update.message.text
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —ñ—Å–Ω—É—î –∞–∫—Ç–∏–≤–Ω–∞ –≥—Ä–∞ –¥–ª—è —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    if chat_id not in user_chats:
        await update.message.reply_text("–ë—É–¥—å –ª–∞—Å–∫–∞, –ø–æ—á–Ω—ñ—Ç—å –Ω–æ–≤—É –≥—Ä—É –∫–æ–º–∞–Ω–¥–æ—é /start.")
        return

    chat = user_chats[chat_id]
    
    # –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≥—Ä–∞–≤—Ü—è –≤ –ø–æ—Ç–æ—á–Ω–∏–π —á–∞—Ç Gemini
    try:
        response = chat.send_message(user_message)
        await update.message.reply_text(response.text)
        
        # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –≥—Ä–∏
        if "–ü–µ—Ä–µ–º–æ–≥–∞" in response.text or "–ü—Ä–æ–≥—Ä–∞—à" in response.text:
            del user_chats[chat_id] # –í–∏–¥–∞–ª—è—î–º–æ —á–∞—Ç –∑—ñ —Å–ø–∏—Å–∫—É –∞–∫—Ç–∏–≤–Ω–∏—Ö
            await update.message.reply_text("–ì—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ü–æ—á–Ω—ñ—Ç—å –Ω–æ–≤—É —Å–ø—Ä–∞–≤—É –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é /start.")
            
    except Exception as e:
        # –£ —Ä–∞–∑—ñ –ø–æ–º–∏–ª–∫–∏ API (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∑–∞–∫—ñ–Ω—á–∏–≤—Å—è –ª—ñ–º—ñ—Ç), —Å–ø–æ–≤—ñ—â–∞—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        await update.message.reply_text(f"–í–∏–Ω–∏–∫–ª–∞ —Ç–µ—Ö–Ω—ñ—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞: {e}. –°–ø—Ä–æ–±—É–π—Ç–µ /start –∑–Ω–æ–≤—É.")

def main() -> None:
    """–ó–∞–ø—É—Å–∫–∞—î –±–æ—Ç–∞."""
    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –∫–ª—é—á—ñ–≤ (—Ö–æ—á–∞ –º–∏ —ó—Ö –≤–∂–µ —ñ–Ω—Ç–µ–≥—Ä—É–≤–∞–ª–∏)
    if not TELEGRAM_BOT_TOKEN or not GEMINI_API_KEY:
        print("–ü–û–ú–ò–õ–ö–ê: –ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å TELEGRAM_BOT_TOKEN —Ç–∞ GEMINI_API_KEY —É –∫–æ–¥—ñ.")
        return

    # –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–æ–≥—Ä–∞–º–∏ Telegram
    application = Application.builder().token(TELEGRAM_BOT_TOKEN).build()

    # –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤
    application.add_handler(CommandHandler("start", start_command))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ (Polling)
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω–æ. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å Ctrl+C, —â–æ–± –∑—É–ø–∏–Ω–∏—Ç–∏.")
    application.run_polling(poll_interval=3)

if __name__ == "__main__":
    main()